#!/bin/bash
set -e

if [ "$#" -ne 2 ]; then
    echo "Usage: $0 <config_dir> <VPS_PUBLIC_IP>" >&2
    echo "Example: $0 /etc/wireguard 72.62.128.176" >&2
    exit 1
fi

CONFIG_DIR="$1"
VPS_IP="$2"

if [ ! -d "$CONFIG_DIR" ]; then
    echo "Error: $CONFIG_DIR is not a directory" >&2
    exit 1
fi

for f in "$CONFIG_DIR"/*.conf; do
    [ -e "$f" ] || continue
    base=$(basename "$f")
    tmp=$(mktemp)

    echo "Patching $base for SSH safety (VPS IP: $VPS_IP)"

    # Insert PostUp/PostDown after [Interface]
    awk -v ip="$VPS_IP" '
        BEGIN {patched=0}
        /^\[Interface\]/ {
            print
            in_iface=1
            next
        }
        in_iface && /^\[/ {
            # New section starts -> insert before this
            print "PostUp = ip rule add from " ip " lookup main    # SSH-KEEPALIVE"
            print "PostDown = ip rule delete from " ip " lookup main"
            in_iface=0
            print
            patched=1
            next
        }
        {
            print
        }
        END {
            if (in_iface && !patched) {
                # Inject rules at end of file if interface was last section
                print "PostUp = ip rule add from " ip " lookup main    # SSH-KEEPALIVE"
                print "PostDown = ip rule delete from " ip " lookup main"
            }
        }
    ' "$f" > "$tmp"

    sudo mv "$tmp" "$f"
    sudo chmod 600 "$f"
done

echo "All configs in $CONFIG_DIR patched successfully."
